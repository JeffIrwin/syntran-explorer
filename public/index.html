
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title id="title">Syntran explorer</title>
	<link rel="stylesheet" href="styles.css">
	<link rel="shortcut icon" type="image/png" href="/favicon.png?v=2">
</head>

<body>
	<div class="container">
	<!-- <div style="display: table; margin: auto;"> -->
	<div style="max-width: fit-content; margin: auto;">
		<h1 id="heading1">Syntran explorer</h1>
		<h3>Help: <a href="https://github.com/JeffIrwin/syntran">documentation</a> </h3>

		<label for="sample" style="display: inline-block;">Choose a sample: &nbsp;</label>
		<select name="sample" id="sample" onChange=submitSampleSelect()>
			<option value="hello">hello world</option>
			<option value="for">for loops</option>
			<option value="arrays">arrays</option>
		</select>

		<form id="textForm">
			<label for="sourceText">Source:</label>
			<div class="grow-wrap">
			<textarea
			id="sourceText"
			name="text"
			rows="4"
			cols="20"
			autofocus=true
			spellcheck=false
			required
			>println("hello world");</textarea>
			</div>
			<br>

			<button type="submit">Run (Ctrl+Enter)</button>
		</form>

		<div id="responseContainer">
			<h2>Output:</h2>
			<pre id="responseText"></pre>
		</div>

	</div>
	</div>

<script>

function countLines(str) {
	return str.split(/\r\n|\r|\n/).length;
}

function submitSampleSelect() {
	const sample = document.querySelector('#sample');
	//console.log("id = ", sample.selectedIndex);
	console.log("vl = ", sample.value);

	// Setting elem.textContent works *until* the user edits the
	// textarea.  After that it can only be changed in javascript via
	// elem.value
	elem = document.getElementById('sourceText');
	switch (sample.value) {
		case "hello":
			elem.value = HELLO_SRC;
			elem.rows = 4;
			break;

		case "for":
			elem.value = FOR_SRC;
			elem.rows = countLines(elem.value);
			break;

		case "arrays":
			elem.value = ARRAYS_SRC;
			elem.rows = countLines(elem.value);
			break;

		default:
			break;
		}

		//console.log("lines = ", countLines(elem.value));
		elem.rows = Math.max(elem.rows, countLines(elem.value) + 1);
}

fetch('/getenv', {
	method: 'POST',
})
.then(response => response.text())
.then(data => {
	//console.log("data = ", data);
	if (data == "staging") {
		document.getElementById("heading1").innerText = "Syntran explorer staging";
		document.getElementById("title").innerText = "Syntran explorer staging";
}
})
.catch(error => {
	console.error('Fetch error:', error);
});

function submitSourceForm(form) {
	event.preventDefault(); // prevent default behavior

	// Set this to indicate possibly long-running jobs
	document.getElementById('responseText').innerText = "Running ...";

	// Create a FormData object from the form
	const formData = new FormData(form);

	//// Debug log
	//for (let [key, value] of formData.entries()) {
	//    console.log(`FormData entry: ${key} = ${value}`);
	//}

	// Send FormData using fetch and update the output with response
	// data
	fetch('/submit', {
		method: 'POST',
		body: formData
	})
	.then(response => response.text())
	.then(data => {
		document.getElementById('responseText').innerHTML = data;
	})
	.catch(error => {
		console.error('Fetch error:', error);
	});
}

// Listen on whole page for hotkey, regardless of where focus is
document.addEventListener('keydown', function(event) {
	if(event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
		submitSourceForm(document.getElementById("textForm"));
	}
});

document.getElementById('textForm').addEventListener('submit', function(event) {
	submitSourceForm(this);
});

const growers = document.querySelectorAll(".grow-wrap");
growers.forEach((grower) => {
  const textarea = grower.querySelector("textarea");
  textarea.addEventListener("input", () => {
    grower.dataset.replicatedValue = textarea.value;
  });
});

const HELLO_SRC =
'println("hello world");';

const FOR_SRC =
'for i in [0: 5] {\n' +
'    println("i = ", i);\n' +
'}\n' +
'\n' +
'// Calculate Ï€\n' +
'let pi = 0.0;\n' +
'for k in [0: 10] {\n' +
'    pi += 1 / (16.0 ** k) * (\n' +
'        4.0 / (8*k + 1) -\n' +
'        2.0 / (8*k + 4) -\n' +
'        1.0 / (8*k + 5) -\n' +
'        1.0 / (8*k + 6)\n' +
'    );\n' +
'}\n' +
'println("pi = ", pi);\n' +
'';

const ARRAYS_SRC =
'let matrix = [\n' +
'    0,  1,  2,  // values\n' +
'    3,  4,  5,\n' +
'    6,  7,  8,\n' +
'    9, 10, 11 ;\n' +
'    3, 4        // size\n' +
'];\n' +
'\n' +
'let x_slice = matrix[:,0];\n' +
'println("x_slice = ", x_slice);\n' +
'\n' +
'let y_slice = matrix[1,:];\n' +
'println("y_slice = ", y_slice);\n' +
'\n' +
'let mat_slice = matrix[0: 2, 1: 4];\n' +
'println("mat_slice = ", mat_slice);\n' +
'';

</script>
</body>
</html>

